<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <title>Simple Chat Room Demo</title>
</head>
<body>
	<p>PubSub over WebSockets using the WS3V Protocol</p>
	<p>Simple Chat Room Demo</p>
    <div id="rooms" style="width:100%; clear:both">
	loading rooms...
    </div>
	<script src="../../WS3V/websocket.js"></script>
    
    <!-- Debug Mode Requires the Following Styles and Scripts -->
    <link rel="stylesheet" href="../../WS3V/debug-assets/css/styles.css">
    <script src="../../WS3V/debug-assets/vkbeautify/vkbeautify.js"></script>
    <!-- End Debug Required -->
    
    <script>
	function getListing()
	{
		// make sure websocket is open and supports channels
		if(PubSub.SocketState == WS3VWebSocket.prototype.SocketStates.Open && PubSub.channels)
		{
			// this is how a request looks, it is based on async "promises", which states that eventually the request will return a value
			PubSub.Channels(
			{
				// if the request works
				callback: function(channels, meta)
				{
					createRooms(channels, meta);
				}
			});
		}
	};
	
	function leave(id, uri)
	{
		document.getElementById(id + '_messages').innerHTML = "";
		document.getElementById(id + '_controls').innerHTML = "<input id=\"join\" onclick=\"joinroom('" + id + "','"+uri+"')\" type=\"button\" value=\"Join Room\">";
	};
	
	function send(id, uri)
	{
		// make sure websocket is open
		if(PubSub.SocketState == WS3VWebSocket.prototype.SocketStates.Open)
		{
			// publish the message to the specified channel
			PubSub.Publish(
			{
				message: 
				{
					message: document.getElementById(id + '_message').value,
					client: PubSub.session_id
				},
				uri: uri,
				echo: true
			});
			
			// clear textbox
			document.getElementById(id + '_message').value = '';
		}
	}
	
	function joinroom(id, uri)
	{
		// this is how a channel subscription works
		// notice how each parameter is an array, the spec states subscription allows multiple
		// channel subscriptions with the same command
		PubSub.Subscribe({
			uri:
			[
				uri
			],
			
			// if the channel exists and allow subscription
			// this is the call back that will fire
			connected:
			[
				function(data)
				{
					document.getElementById(id + '_controls').innerHTML = "<input required id=\"" + id + "_message\" size=\"32\" placeholder=\"message\"/><input id=\"add\" onclick=\"send('" + id + "','" + uri + "')\" type=\"button\" value=\"Send\"><input id=\"add\" onclick=\"leave('" + id + "','"+uri+"')\" type=\"button\" value=\"Leave Room\">";
				}
			],
			
			// when connected this will fire on new messages (events) published to the channel
			events:
			[
				function(data)
				{
					document.getElementById(id + '_messages').innerHTML = "<br /><strong>"+((data.message.client == PubSub.session_id) ? "me" : data.message.client)+":</strong> "+data.message.message + document.getElementById(id + '_messages').innerHTML;
				}
			],
			
			// if we are denied access to the channel
			// this is the callback that will fire
			deny:
			[
				function(error, description, url)
				{
					console.log(error);
					console.log(description);
					console.log(url);
				}
			]
		});	
	};
	
	function createRooms(channels, meta)
	{
		var html = '';
		
		for (var i=0; i < channels.length; i++)
			html = html + '<div style="width:33%; float:left;"><div><i>'+channels[i]+'</i></div><div><strong>'+meta[i][0]+'</strong></div><div>'+meta[i][1]+'</div><div id="R'+i+'_messages"></div><div id="R'+i+'_controls"><input id="join" onclick="joinroom(\'R'+i+'\',\''+channels[i]+'\')" type="button" value="Join Room"></div></div>';
        
		document.getElementById('rooms').innerHTML = html;
	}
		
	function websocket()
	{	
		// build the WS3V WebSocket
		PubSub = new WS3VWebSocket
		({ 
			Server: "127.0.0.1",
			Port: 8181,
			Action: "RPCAPI",
			DebugMode: true
		});
		
		
		
		PubSub.Connected = function()
		{
			getListing();
			console.log("connected");
		};
		
		PubSub.Disconnected = function()
		{
			console.log("good bye");
		};
		
		// start the connection
		PubSub.Connect();
	}
	
	websocket();
	
	</script>
    <p style="clear:both">&nbsp;</p>
    <div class="footer container pad-sides-40" style="clear:both">
        <div class="copy">WS3V is an open WebSocket protocol providing modern web standard solutions for RESTful APIs.</div>
        <div class="trademark"><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">WS3V</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://ws3v.org" property="cc:attributionName" rel="cc:attributionURL" target="_blank">Mike Olsen</a> is licensed under a <a target="_blank" rel="license" href="http://creativecommons.org/licenses/by/3.0/deed.en_US">Creative Commons Attribution 3.0 Unported License</a>.</div>
    </div>
</body>
</html>
